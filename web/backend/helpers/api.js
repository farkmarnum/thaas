const url = require('url');

const router = require('express').Router();

const { listObjects, streamObject } = require('./s3');
const {
  handleCommand,
  handleSlackOAuth,
  handleSlackInstall,
} = require('./slack');
const { getTom } = require('./tom');

router.get('/tom', async (_req, res) => {
  const objects = await listObjects();
  const index = Math.floor(objects.length * Math.random());
  const key = objects[index];

  await streamObject(key, res);
});

router.post('/integrations/slack', async (req, res) => {
  const paramString = Buffer.from(req.body, 'base64').toString('ascii');
  const paramsParsed = url.parse(`example.com/?${paramString}`, true).query;
  const bodyParams = { ...paramsParsed };

  res.json(await handleCommand(bodyParams));
});

router.get('/integrations/slack/oauth', async (req, res) => {
  await handleSlackOAuth(req, res);
});

router.get('/integrations/slack/install', async (req, res) => {
  await handleSlackInstall(req, res);
});

router.get('/integrations/github', async (_req, res) => {
  const urlWithPath = await getTom();
  const fullUrl = `https://${urlWithPath}`;

  res.json({ imageUrl: fullUrl });
});

module.exports = router;
